# 测试组织与入口规范（Julia_RelaxTime）

更新时间：2026-01-13

本文件用于统一项目内测试的放置规则、命名规则与入口策略，目标是：
- 默认测试入口“稳定、确定、快速”（CI/本地都不折腾）。
- 允许逐步清理历史测试/脚本/性能探针，而不影响主分支开发体验。

## 目录分层（必须遵守）

- `tests/unit/`：单元测试（确定性、快速、无外部依赖）
- `tests/analysis/`：分析/验证类测试（可能慢、可能依赖数据文件、允许更宽松）
- `tests/perf/`：性能/基准（允许很慢、可打印 timing、可调节点数）
- `scripts/`：交互诊断/一次性检查/扫描脚本（不算测试入口的一部分）

## Unit 测试准入规则（硬规则）

unit 只允许放满足以下全部条件的测试：
1. **确定性**：固定随机种子；结果不依赖运行时机/线程调度/浮点噪声放大。
2. **快速**：默认配置下可接受的时间内结束（建议单文件 < 1–2s，整套 smoke < 1min）。
3. **无外部依赖**：不依赖网络、不依赖大数据文件、不依赖用户本地环境（除 `--project=.` 之外）。
4. **不混杂**：不把脚本、性能探针、交互诊断代码放进 `tests/unit`。

不满足上述条件的内容：
- 放 `tests/analysis` / `tests/perf` / `scripts`。

## 子系统分目录（推荐做法，逐步迁移）

按子系统分目录管理：
- `tests/unit/pnjl/`：PNJL 求解器、热力学、积分缓存等的单元测试
- `tests/unit/relaxtime/`：RelaxTime/散射率/截面等单元测试
- `tests/unit/integration/`：跨模块但仍应快速、确定的“小集成”测试（可选）

根目录 `tests/unit/*.jl` 只保留：
- `tests/unit/runtests.jl`（入口）
- 少量“通用数值算法”测试（如果无法明确归属）

## 单测命名

- 单测文件统一：`test_*.jl`
- 非单测脚本严禁命名为 `test_*.jl`（否则容易被入口误 include）

## 单测入口策略（现行）

入口文件：`tests/unit/runtests.jl`

提供两种运行档：
- `UNIT_PROFILE=smoke`（默认）：精选、稳定、确定性的测试集合，要求长期保持绿色。
- `UNIT_PROFILE=full`：更大范围的 include，用于逐步修复/迁移历史测试；允许短期不全绿，但要以“逐步变绿”为目标。

可用环境变量（以入口实现为准）：
- `UNIT_PROFILE=smoke|full`
- `UNIT_INCLUDE_PERF=1`：仅在 full 下有意义，用于允许 include 名称包含 performance 的文件（默认关闭）。

## PNJL 求解器相关约定

- 在 unit 中涉及随机采样的测试必须是**确定性的**（固定 RNG seed），并且默认样本数要保守；可通过 ENV 提升样本数做压力回归。
- “在参数空间内找失败点/分支问题”的扫描应作为脚本放在 `scripts/pnjl/`，而不是 unit。

## 迁移/清理建议（路线）

1. 把 `tests/unit/` 根目录下明显属于子系统的文件迁入对应子目录。
2. 修复过时 API、移除非单测脚本、将 perf 探针迁到 `tests/perf/`。
3. 逐步扩大 smoke 覆盖面，让 full 越来越绿。
