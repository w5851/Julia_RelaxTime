# PNJL 模型一阶相变双分支扫描策略

> 文档版本：2025-12-29
> 相关代码：`src/pnjl/scans/DualBranchScan.jl`

---

## 一、问题背景

### 1.1 一阶相变的多值解问题

在 PNJL 模型中，当温度 T < T_CEP（临界终点温度）时，存在一阶手征相变。在相变区域：

- **能隙方程存在多个解**：强子相（手征对称性自发破缺）和夸克相（手征对称性恢复）
- **亚稳态区域**：两相可以共存，但只有一个是热力学稳定的（Ω 最小）
- **相变点**：两相的巨热力学势相等 Ω_hadron(μ_c) = Ω_quark(μ_c)

### 1.2 传统单向扫描的问题

传统的单向扫描（如从低 μ 向高 μ）存在以下问题：

1. **初值依赖**：求解器可能收敛到亚稳态而非稳定态
2. **相变跳跃**：在相变点附近可能突然跳到另一个分支
3. **无法获取完整信息**：只能得到一个分支的解，无法比较 Ω

---

## 二、双分支扫描策略

### 2.1 核心思想

通过双向扫描分别追踪两个分支：

```
强子分支：μ_min → μ_max（使用强子相初值，连续性跟踪）
夸克分支：μ_max → μ_min（使用夸克相初值，连续性跟踪）
```

### 2.2 三个关键化学势

对于每个温度 T，双分支扫描可以确定三个关键化学势：

| 符号 | 名称 | 物理意义 |
|------|------|----------|
| μ_c | 相变点 | Ω_hadron = Ω_quark，热力学稳定相发生转变 |
| μ_hadron_spinodal | 强子相亚稳态边界 | 强子相解消失的化学势（spinodal line） |
| μ_quark_spinodal | 夸克相亚稳态边界 | 夸克相解出现的化学势（spinodal line） |

**关系**：μ_quark_spinodal < μ_c < μ_hadron_spinodal

### 2.3 相图结构

```
        T
        ↑
        │     Crossover
   T_CEP├─────────●─────────────
        │        ╱ ╲
        │       ╱   ╲  一阶相变区
        │      ╱     ╲
        │     ╱ 共存区 ╲
        │    ╱         ╲
        │   ╱           ╲
        └──┴─────────────┴──→ μ
           μ_q   μ_c   μ_h
           spinodal    spinodal
```

---

## 三、实现细节

### 3.1 连续性跟踪

使用 `ContinuitySeed` 策略，将前一点的解作为下一点的初值：

```julia
hadron_tracker = ContinuitySeed(fallback=DefaultSeed(phase_hint=:hadron))

for mu in mu_range
    result = solve(FixedMu(), T, mu; seed_strategy=hadron_tracker)
    update!(hadron_tracker, result.solution)
end
```

### 3.2 解跳跃检测

当序参量或有效质量突变时，停止分支追踪：

```julia
function _is_solution_jump(prev, curr; phi_threshold=0.5, mass_threshold=50.0)
    delta_phi = abs(prev.x_state[1] - curr.x_state[1])
    delta_M = abs(prev.masses[1] - curr.masses[1]) * 197.327  # MeV
    return delta_phi > phi_threshold || delta_M > mass_threshold
end
```

**跳跃检测的意义**：
- 防止追踪到非物理解（如 φ_u ≈ -5 的解）
- 确定亚稳态边界（spinodal line）

### 3.3 同解检测

当两分支收敛到同一解时，不应计入共存区：

```julia
function _is_same_solution(h, q; tol=0.01)
    delta_phi = abs(h.x_state[1] - q.x_state[1])
    delta_Phi = abs(h.x_state[4] - q.x_state[4])
    delta_M = abs(h.masses[1] - q.masses[1])
    return delta_phi < tol && delta_Phi < tol && delta_M < tol * 197.327
end
```

### 3.4 相变点定位

在共存区内寻找 Ω 交叉点（线性插值）：

```julia
# ΔΩ = Ω_hadron - Ω_quark
# 寻找 ΔΩ 符号变化的位置
for i in 1:(n-1)
    if delta[i] * delta[i+1] < 0
        t = delta[i] / (delta[i] - delta[i+1])
        mu_c = mu[i] + t * (mu[i+1] - mu[i])
    end
end
```

---

## 四、使用示例

### 4.1 单温度扫描

```julia
using PNJL

result = run_dual_branch_scan(
    T_mev = 100.0,
    mu_range = 200.0:5.0:400.0,
    xi = 0.0,
    verbose = true
)

trans = find_phase_transition(result)

if trans.found
    println("相变点: μ_c = $(trans.mu_c) MeV")
    println("强子相 spinodal: $(trans.mu_hadron_spinodal) MeV")
    println("夸克相 spinodal: $(trans.mu_quark_spinodal) MeV")
end
```

### 4.2 多温度相变线扫描

```julia
transitions = scan_phase_diagram(
    T_range = 50.0:10.0:130.0,
    mu_range = 200.0:5.0:400.0,
    output_dir = "results/phase_diagram/"
)
```

### 4.3 输出数据

`merge_branches()` 输出的 CSV 包含：

| 列名 | 说明 |
|------|------|
| branch | 分支标记：hadron/quark/same |
| delta_omega | Ω_hadron - Ω_quark（仅共存区有值） |
| M_u_MeV | 有效质量（区分两相的关键指标） |

---

## 五、测试结果

### 5.1 各向同性情况 (ξ = 0)

CEP 参数：T_CEP ≈ 131 MeV, μ_CEP ≈ 291 MeV

| T (MeV) | μ_c (MeV) | μ_quark_spinodal | μ_hadron_spinodal | 共存区宽度 |
|---------|-----------|------------------|-------------------|------------|
| 50 | 356 | 350 | 365 | 15 MeV |
| 80 | 345 | 340 | 350 | 10 MeV |
| 100 | 331 | 330 | 335 | 5 MeV |
| 120 | 309 | 308 | 309 | ~1 MeV |

**观察**：
- 随温度升高，相变点 μ_c 降低
- 随温度升高，共存区变窄
- 接近 CEP 时，共存区趋于零

### 5.2 相变特征

在相变点附近：
- **强子相**：φ_u ≈ -1.8, M_u ≈ 360 MeV, Φ ≈ 0.01
- **夸克相**：φ_u ≈ -0.2, M_u ≈ 40 MeV, Φ ≈ 0.06

---

## 六、注意事项

### 6.1 网格密度

- 远离 CEP：5-10 MeV 步长足够
- 接近 CEP：需要 1-2 MeV 步长
- 共存区很窄时可能需要更细的网格

### 6.2 初值选择

- 强子分支：使用 `HADRON_SEED_5`（φ_u ≈ -1.84）
- 夸克分支：使用 `QUARK_SEED_5`（φ_u ≈ -0.73）

### 6.3 跳跃阈值

默认阈值：
- φ 变化 > 0.5
- M 变化 > 50 MeV

可根据具体情况调整。

---

## 七、相关文件

- 实现代码：`src/pnjl/scans/DualBranchScan.jl`
- 测试脚本：`scripts/test_dual_branch_scan.jl`
- 调试脚本：`scripts/debug_dual_branch.jl`
- 开发笔记：`docs/dev/PNJL_Solver_Refactoring_Notes.md`

---

## 八、参考文献

1. PNJL 模型相变：Fukushima, K. (2004). Phys. Lett. B 591, 277.
2. Spinodal 分解：Randrup, J. (2010). Phys. Rev. C 82, 034902.
