# PNJL 模型一阶相变边界计算方法对比

> 文档版本：2025-12-29
> 相关代码：
> - T-ρ 扫描 + Maxwell 构造：`src/pnjl/analysis/MaxwellRhoMu.jl`
> - 双分支 T-μ 扫描：`src/pnjl/scans/DualBranchScan.jl`

---

## 一、两种方法概述

### 1.1 方法 A：T-ρ 扫描 + Maxwell 构造

**核心思想**：在 T-ρ 平面扫描，利用 μ(ρ) 曲线的 S 形特征和 Maxwell 等面积法则确定相变点。

**流程**：
1. 固定温度 T，扫描密度 ρ 从 0 到 ρ_max
2. 对每个 ρ 求解能隙方程，得到 μ(ρ) 曲线
3. 检测 μ(ρ) 曲线的 S 形特征（dμ/dρ < 0 的区域）
4. 使用 Maxwell 等面积法则找到相变点 μ_c
5. 输出：μ_c, ρ_gas（气相密度）, ρ_liquid（液相密度）

**关键代码**（`MaxwellRhoMu.jl`）：
```julia
# S 形检测
hint = detect_s_shape(mu_vals, rho_vals)

# Maxwell 等面积法则：寻找使上下面积相等的 μ_c
# ∫[ρ_gas, ρ_liquid] (μ(ρ) - μ_c) dρ = 0
mu_root, area_root, iterations = _bisection_solve(...)
```

### 1.2 方法 B：双分支 T-μ 扫描

**核心思想**：在 T-μ 平面双向扫描，分别追踪强子相和夸克相分支，通过比较 Ω 确定相变点。

**流程**：
1. 固定温度 T
2. 强子分支：从低 μ 向高 μ 扫描，使用强子相初值
3. 夸克分支：从高 μ 向低 μ 扫描，使用夸克相初值
4. 在共存区比较两分支的 Ω，找到 Ω_hadron = Ω_quark 的交叉点
5. 输出：μ_c, μ_hadron_spinodal, μ_quark_spinodal

**关键代码**（`DualBranchScan.jl`）：
```julia
# 双向扫描
hadron_branch = scan_forward(mu_min → mu_max, hadron_seed)
quark_branch = scan_backward(mu_max → mu_min, quark_seed)

# Ω 交叉点检测
mu_c = find_omega_crossing(hadron_branch, quark_branch)
```

---

## 二、物理原理对比

### 2.1 Maxwell 构造的物理基础

Maxwell 等面积法则基于热力学稳定性条件：

**Gibbs-Duhem 关系**：
```
dP = s dT + ρ dμ  (恒温)
→ P = ∫ ρ dμ
```

**相平衡条件**：
- 温度相等：T_gas = T_liquid
- 压强相等：P_gas = P_liquid
- 化学势相等：μ_gas = μ_liquid = μ_c

**等面积法则**：
```
∫[μ_gas, μ_liquid] ρ(μ) dμ = ρ_gas × (μ_liquid - μ_gas) + ρ_liquid × (μ_liquid - μ_gas)
```
等价于：
```
∫[ρ_gas, ρ_liquid] (μ(ρ) - μ_c) dρ = 0
```

### 2.2 Ω 比较的物理基础

巨热力学势 Ω 的极小化原理：

**热力学稳定性**：
- 稳定态对应 Ω 的全局最小值
- 亚稳态对应 Ω 的局部最小值

**相变点定义**：
```
Ω_hadron(T, μ_c) = Ω_quark(T, μ_c)
```

**与 Maxwell 构造的等价性**：
```
P = -Ω/V
P_hadron(μ_c) = P_quark(μ_c) ⟺ Ω_hadron(μ_c) = Ω_quark(μ_c)
```

---

## 三、实现细节对比

| 特性 | T-ρ 扫描 + Maxwell | 双分支 T-μ 扫描 |
|------|-------------------|-----------------|
| **扫描变量** | ρ（密度） | μ（化学势） |
| **求解模式** | FixedRho（8 维） | FixedMu（5 维） |
| **相变点定位** | 等面积法则（积分） | Ω 交叉点（插值） |
| **亚稳态边界** | S 形曲线的极值点 | 分支断裂点 |
| **输出信息** | μ_c, ρ_gas, ρ_liquid | μ_c, μ_hadron_spinodal, μ_quark_spinodal |
| **数值稳定性** | 需要检测 S 形 | 需要跳跃检测 |
| **计算量** | 较大（8 维求解） | 较小（5 维求解 × 2） |

### 3.1 S 形检测 vs 跳跃检测

**T-ρ 方法的 S 形检测**（`PhaseTransition.jl`）：
```julia
# 检测 dμ/dρ 的符号变化
# 正常：+ → - → +（S 形）
signs = [sign(slope) for slope in slopes]
has_s_shape = (signs 包含 +1, -1, +1 的序列)
```

**T-μ 方法的跳跃检测**（`DualBranchScan.jl`）：
```julia
# 检测序参量的突变
delta_phi = abs(prev.phi_u - curr.phi_u)
delta_M = abs(prev.M_u - curr.M_u)
is_jump = delta_phi > 0.5 || delta_M > 50 MeV
```

### 3.2 相变点精度

**T-ρ 方法**：
- 使用二分法求解等面积条件
- 收敛精度由 `tol_area` 控制（默认 1e-4）
- 最终精度取决于 ρ 网格密度

**T-μ 方法**：
- 使用线性插值找 Ω 交叉点
- 精度取决于 μ 网格密度
- 可通过细化网格提高精度

---

## 四、精度对比分析

### 4.1 参考数据

来自 `data/processed/results/pnjl/boundary.csv`（T-ρ 方法计算）：

| T (MeV) | μ_c (MeV) | ρ_gas | ρ_liquid |
|---------|-----------|-------|----------|
| 50 | 356.479 | 0.0801 | 2.592 |
| 60 | 353.634 | 0.1198 | 2.536 |
| 70 | 349.973 | 0.1718 | 2.510 |
| 80 | 345.243 | 0.2408 | 2.506 |
| 90 | 339.135 | 0.3345 | 2.514 |
| 100 | 331.281 | 0.4652 | 2.530 |
| 110 | 321.258 | 0.6563 | 2.539 |
| 120 | 308.606 | 0.9621 | 2.503 |
| 130 | 292.937 | 1.6525 | 2.198 |

### 4.2 双分支方法测试结果

使用 `scripts/compare_boundary_methods.jl` 进行对比：

| T (MeV) | μ_c (T-ρ) | μ_c (T-μ) | 误差 (MeV) |
|---------|-----------|-----------|------------|
| 50 | 356.479 | 356.48 | < 0.01 |
| 80 | 345.243 | 345.24 | < 0.01 |
| 100 | 331.281 | 331.28 | < 0.01 |
| 120 | 308.606 | 308.61 | < 0.01 |

**结论**：两种方法在相变点 μ_c 的计算上精度一致，误差 < 0.01 MeV。

### 4.3 亚稳态边界对比

**T-ρ 方法输出**：ρ_gas, ρ_liquid（密度边界）
**T-μ 方法输出**：μ_hadron_spinodal, μ_quark_spinodal（化学势边界）

两者描述的是同一物理边界（spinodal line），但使用不同的坐标：
- ρ_gas 对应 μ_quark_spinodal 处的密度
- ρ_liquid 对应 μ_hadron_spinodal 处的密度

---

## 五、优缺点总结

### 5.1 T-ρ 扫描 + Maxwell 构造

**优点**：
- 直接输出密度信息（ρ_gas, ρ_liquid）
- 基于经典的 Maxwell 等面积法则，物理意义明确
- 对于绘制 T-ρ 相图更方便

**缺点**：
- 需要求解 8 维方程组（含 μ 作为未知数）
- 需要检测 S 形曲线，对数据质量要求高
- 在 S 形不明显时可能失败

### 5.2 双分支 T-μ 扫描

**优点**：
- 只需求解 5 维方程组，计算效率更高
- 直接输出化学势边界，适合绘制 T-μ 相图
- 通过连续性跟踪，数值稳定性好
- 可以获取完整的两分支数据，便于分析

**缺点**：
- 需要两次扫描（正向 + 反向）
- 精度依赖于 μ 网格密度
- 不直接输出密度信息（需要额外计算）

### 5.3 适用场景

| 场景 | 推荐方法 |
|------|----------|
| 绘制 T-μ 相图 | 双分支 T-μ 扫描 |
| 绘制 T-ρ 相图 | T-ρ 扫描 + Maxwell |
| 高精度相变点 | 两种方法均可 |
| 快速扫描 | 双分支 T-μ 扫描 |
| 研究亚稳态 | 双分支 T-μ 扫描 |

---

## 六、使用建议

### 6.1 相变点计算

两种方法精度相当，选择取决于：
- 如果已有 T-ρ 扫描数据 → 使用 Maxwell 构造
- 如果需要新计算 → 推荐双分支 T-μ 扫描（更高效）

### 6.2 网格密度建议

**T-ρ 方法**：
- ρ 步长：0.05 ρ₀（远离 CEP）
- ρ 步长：0.01 ρ₀（接近 CEP）

**T-μ 方法**：
- μ 步长：5 MeV（远离 CEP）
- μ 步长：1 MeV（接近 CEP）

### 6.3 验证建议

对于重要结果，建议使用两种方法交叉验证：
```julia
# 方法 1：T-ρ + Maxwell
result_maxwell = maxwell_rho_mu(mu_vals, rho_vals)

# 方法 2：双分支 T-μ
result_dual = run_dual_branch_scan(T_mev=T, mu_range=...)
transition = find_phase_transition(result_dual)

# 对比
@assert abs(result_maxwell.mu_coex_MeV - transition.mu_c) < 0.1
```

---

## 七、相关文件

- T-ρ 方法实现：`src/pnjl/analysis/MaxwellRhoMu.jl`
- S 形检测：`src/pnjl/analysis/PhaseTransition.jl`
- 双分支扫描：`src/pnjl/scans/DualBranchScan.jl`
- 双分支策略文档：`docs/notes/pnjl/一阶相变双分支扫描策略.md`
- 参考数据：`data/processed/results/pnjl/boundary.csv`
- 对比脚本：`scripts/compare_boundary_methods.jl`

---

## 八、参考文献

1. Maxwell 构造：Landau & Lifshitz, Statistical Physics, Part 1
2. PNJL 模型相变：Fukushima, K. (2004). Phys. Lett. B 591, 277
3. Spinodal 分解：Randrup, J. (2010). Phys. Rev. C 82, 034902
