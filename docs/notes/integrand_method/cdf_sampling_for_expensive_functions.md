# 用 CDF 采样“昂贵函数”并插值复用（w0cdf / cdf_wSigma 方法笔记）

## 目标与动机
在弛豫时间相关计算里，经常遇到两类计算量差异巨大的部分：

1. **昂贵函数**：例如散射截面 $\sigma(s)$（需要内部一维/二维积分、传播子、单圈积分等），单点代价高。
2. **便宜但高维的积分核**：例如 5D 积分中的权重与运动学部分，单点代价相对低但需要大量采样点。

为了降低总耗时，一个常用思路是：

- 先在 $s$（或 $\sqrt{s}$）上一小组**精心选取**的点上计算昂贵的 $\sigma(s)$；
- 然后在高维积分中用插值 $\tilde\sigma(s)$ 替代“每个 5D 网格点都算一次 $\sigma$”。

关键问题变成：**怎么选这组 $s$ 点，才能在固定 N（例如 N=60）下最大化整体精度？**

## 核心思想：用“重要性权重”的 CDF 来设计采样点

### 1) w0cdf：用不含 $\sigma$ 的权重 $w_0$ 来设计 $\sqrt{s}$ 网格

在 5D 积分中，积分核通常形如：

$$
\omega \;\sim\; \int d\Gamma\; w_0(\Gamma)\, \sigma(s(\Gamma))
$$

其中 $\Gamma$ 代表 5D 相空间变量（例如 $p_i,p_j,\cos\theta_i,\cos\theta_j,\phi$），而 $w_0$ 吸收了：

- Gauss-Legendre 权重与雅可比
- $p_i^2 p_j^2$
- 分布函数 $f_i f_j$
- 相对速度 $v_{rel}$
- 以及各种阈值/可积域截断

**w0cdf** 方法做的是：

1. 在一套“基准 5D 求积网格”上枚举点 $\Gamma_k$；
2. 对每个点计算 $(\sqrt{s_k}, w_{0,k})$；
3. 将样本按 $\sqrt{s}$ 排序，构造加权 CDF：

$$
F(\sqrt{s}) = \frac{\sum_{\sqrt{s_k}\le \sqrt{s}} w_{0,k}}{\sum_k w_{0,k}}
$$

4. 取 N 个分位点（例如 $q_i=(i-0.5)/N$），得到 N 个 $\sqrt{s}$ 采样点；
5. 在这些点上计算昂贵的 $\sigma(s)$ 并插值（推荐 PCHIP）。

直观理解：**让 $\sqrt{s}$ 的采样密度与“5D 积分把概率质量压在哪些 $\sqrt{s}$ 区间”相匹配。**

### 2) cdf_wSigma：用“包含 $\sigma$ 的权重”来设计（更激进但更贵/更易反馈）

若我们改用

$$
\tilde w(\Gamma) = w_0(\Gamma)\,\sigma(s(\Gamma))
$$

再对 $\sqrt{s}$ 做 CDF 分位点设计，理论上能更聚焦在“对最终积分贡献大的 $\sqrt{s}$”区域。

但代价是：这需要先知道 $\sigma(s)$ 的形状（至少要有一个近似/粗略版），否则会形成闭环依赖。

实践里常见做法是：

- 先用 w0cdf 得到一份粗网格 + 插值 $\tilde\sigma$；
- 再用 $w_0\tilde\sigma$ 生成更聚焦的 cdf_wSigma 网格（可选）。

## 插值选择与建议

- 推荐：**PCHIP（单调三次 Hermite，Fritsch–Carlson）**
  - 对阈值附近/尖峰附近比线性更平滑
  - 不易产生“过冲导致负截面”这类灾难（实现里通常会 clamp 到非负）
- 备选：线性插值
  - 最稳定、最不容易“奇怪”
  - 但在 N 很低时误差尾部可能更大

## 适用情形（什么时候值得用）

### 强烈适用
- $\sigma(s)$ 单点很贵（例如包含内部积分、传播子、循环积分等）。
- 高维积分点数多（5D/6D）且每点重复调用 $\sigma$。
- 希望把耗时从 “O(N_5D \times cost(\sigma))” 变成 “O(N_\sigma \times cost(\sigma) + N_5D \times cost(interp))”。

### 不太适用 / 需要谨慎
- $\sigma(s)$ 很便宜或可解析：此时插值/缓存的管理成本可能不划算。
- 模型在某些参数点会产生**非物理平衡解/非物理传播子**：插值再好也救不了输入不物理。
- 你的 5D 求积本身误差很大（例如节点太少）：这时应先保证 5D 收敛，否则“优化 $\sigma$ 采样”可能是次要矛盾。

## 实践注意事项

1. **w0cdf 网格设计本身也要采样 w0**：它通常在同一套 5D 网格上做一次遍历，成本接近一次“只算核不算 $\sigma$”的积分。
2. **各向异性（$\xi>0$）会改变角度结构**：
   - 若只在 $\xi=0$（各向同性）下评估角度节点数，可能低估角度维度的重要性。
   - 做性能/误差评估时建议至少包含一两个代表性的 $\xi$（例如 0.5、0.8）。
  - 实测提示（一个基准点位/节点组合下）：$\xi=0$ 时把 `angle_nodes` 从 4 提到 6 的 $\omega$ 相对变化量可在 $\sim 10^{-3}$ 量级，而 $\xi=0.8$ 时可上升到 $\sim 5\times 10^{-3}$ 量级；各向异性下角度维更“值得”做收敛性检查。
3. **N 的选择**：经验上 N=60 对很多点已经能把 $\sigma$ 插值误差压到尾部几 %；但若出现明显尖峰/阈值结构，可考虑 N=80/120 或使用混合策略（例如 w0cdf_mix）。

## 关联脚本/实现位置

- 性能基准（N=60 + w0cdf + PCHIP）：
  - tests/perf/relaxtime/benchmark_average_scattering_rate_N60_w0cdf_pchip.jl
- 随机点/扫描中生成 w0cdf/w0cdf_mix 网格并落盘为 `sigma_*.csv`：
  - scripts/relaxtime/sweep_sigma_grid_interp_three_processes.jl
  - scripts/relaxtime/scan_omega_s_importance.jl

