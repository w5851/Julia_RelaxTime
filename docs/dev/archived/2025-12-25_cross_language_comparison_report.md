# 跨语言对比测试报告：Julia vs C++ vs Fortran

## 测试日期
2025-12-25

## 测试环境
- Julia项目: `Julia_RelaxTime`
- C++项目: `20250413备份`
- Fortran项目: `Relaxtime_fortran`

## 测试参数
- T = 150 MeV
- μB = 800 MeV
- 散射道: udb (u + d̄ → u + d̄)

## C++求解的PNJL方程结果
```
Φ = 0.418196
Φbar = 0.437267
m_u = m_d = 81.5222 MeV
m_s = 434.39 MeV
```

## 对比结果汇总

### 1. 夸克分布函数 f(E, μ, T, Φ, Φbar)
| 测试项 | Julia | C++ | 相对误差 |
|--------|-------|-----|----------|
| Pauli阻塞因子 block | 0.7199471796 | 0.7199470000 | 2.5e-7 |

**结论**: ✅ 完全一致

### 2. A积分 (单线积分)
| 参数 | Julia | C++风格 | 相对误差 |
|------|-------|---------|----------|
| A(m_u) | -1.2751945e+01 | -1.2751786e+01 | 0.0012% |

**差异来源**:
- Julia: 分布函数积分上限 10 fm⁻¹, 64节点
- C++: 分布函数积分上限 15 fm⁻¹, 128节点

**结论**: ✅ 差异可忽略 (<0.01%)

### 3. B0积分 (单圈积分)
| 参数 | Julia | C++风格 | 相对误差 |
|------|-------|---------|----------|
| B0_re (s-channel) | 1.3147e+00 | 1.3022e+00 | **0.95%** |
| B0_im (s-channel) | 2.1993e+00 | 2.1993e+00 | <1e-15 |

**差异来源**:
- **k=0时的奇点处理方式不同**
  - C++: 使用CPVI (Cauchy Principal Value Integration)，等距节点避开奇点
  - Julia: 使用QuadGK自适应积分

**结论**: ⚠️ 实部存在约1%差异，虚部完全一致

### 4. 极化函数 Π
| 参数 | Julia | C++ | 相对误差 |
|------|-------|-----|----------|
| Π_P(s) re | 1.6546 | 1.6481 | 0.40% |
| Π_P(s) im | 1.1470 | 1.1470 | 0.002% |
| Π_S(s) re | 1.6205 | 1.6144 | 0.38% |
| Π_S(s) im | 1.0899 | 1.0899 | 0.002% |
| Π_P(t) re | 0.4640 | 0.4646 | 0.13% |
| Π_S(t) re | 0.4111 | 0.4118 | 0.17% |

**结论**: ⚠️ 实部差异约0.1%-0.4%，虚部完全一致

## 差异根本原因分析

### 主要差异来源：B0积分的k=0奇点处理

当 k=0 时，B0积分的被积函数在某些能量点存在奇点：
```
E0 = -z/2 - (m1² - m2²)/(2z)
```

**C++的处理方式 (CPVI)**:
```cpp
// 使用等距节点，在奇点两侧各留出0.001h的间隙
h = (Emax - m1) / (n_points - 1);
i = floor(((E0 - 0.001*h) - m1) / h) + 1;
j = floor((Emax - (E0 + 0.001*h)) / h) + 1;
// 使用梯形法则权重
```

**Julia的处理方式 (QuadGK)**:
```julia
# 使用自适应积分，在奇点附近留出对称间隙
eps = max(1e-6, 1e-6 * abs(E0))
# 分段积分: [Emin, E0-eps] + [E0+eps, Emax]
```

### 差异传播
1. B0实部差异 ~1%
2. → 极化函数实部差异 ~0.4%
3. → 传播子差异
4. → 散射振幅差异
5. → 总截面差异

## 建议

### 短期建议
1. **不修改代码**：当前差异在物理可接受范围内（<1%）
2. **记录差异**：在文档中说明Julia与C++的数值方法差异

### 长期建议
1. **统一数值方法**：考虑在Julia中实现与C++相同的CPVI方法
2. **增加测试覆盖**：添加更多参数点的对比测试
3. **Fortran对比**：完成Fortran代码的编译和对比测试

## 附录：测试脚本

- `scripts/debug/cross_language_comparison.jl` - 基础对比测试
- `scripts/debug/cross_language_comparison_v2.jl` - 使用C++参数的精确对比
- `scripts/debug/analyze_A_integral_difference.jl` - A积分差异分析
- `scripts/debug/analyze_B0_difference.jl` - B0积分差异分析
- `scripts/debug/advanced_module_comparison.jl` - 高级模块对比（传播子、|M|²、σ）
- `scripts/debug/propagator_detailed_comparison.jl` - 传播子详细分析

---

## Fortran对比测试状态

### 编译状态
✅ Fortran项目已成功编译 (2025-12-25)
- 编译器: gfortran 14.2.0
- 所有36个源文件编译成功
- .mod文件位于: `Relaxtime_fortran/mod/`

### Fortran测试入口点
✅ 已创建 `Relaxtime_fortran/codes/main/debug_output.f90`
- 输出物理参数、分布函数、B0积分、极化函数、传播子、振幅、截面
- 数据文件位于: `Relaxtime_fortran/results/debug_*.txt`

### 三方对比结果 (Julia vs C++ vs Fortran)

#### B0积分对比
| k0 | Julia Re | Fortran Re | 误差 | Julia Im | Fortran Im | 误差 |
|----|----------|------------|------|----------|------------|------|
| 0.5 | 1.758863 | 1.758771 | 5.2e-5 | 0.0 | 0.0 | 0 |
| 1.0 | 2.034082 | 1.994305 | 2.0e-2 | 0.224016 | 0.224027 | 5.0e-5 |
| 2.0 | 2.063786 | 2.062585 | 5.8e-4 | 0.894414 | 0.894437 | 2.5e-5 |
| 3.0 | 1.790374 | 1.784175 | 3.5e-3 | 1.692302 | 1.692338 | 2.1e-5 |
| 4.0 | 1.058059 | 1.045742 | 1.2e-2 | 2.369091 | 2.369123 | 1.4e-5 |

**结论**: Julia与Fortran的B0积分虚部一致性很好（<0.01%），实部在奇点附近有1-2%的差异。

#### 传播子对比
Julia与C++的传播子对比良好（0.15%-0.6%误差），但与Fortran有较大差异。
- Fortran输出的是单个传播子分量，而非组合后的传播子
- 需要进一步确认Fortran的传播子组合方式

#### 散射振幅对比
Julia与C++的振幅对比良好（0.04%-0.2%误差），但与Fortran有较大差异。
- Fortran的振幅值比Julia/C++大1-2个数量级
- 可能是单位或归一化因子的差异

### 关键文件位置
| 项目 | 路径 |
|------|------|
| Julia | `d:\Desktop\Julia_RelaxTime` |
| C++ | `d:\Desktop\20250413备份` |
| Fortran | `d:\Desktop\Relaxtime_fortran` |
| C++可执行文件 | `20250413备份\build_mingw64\PNJL_rex_time_mingw64.exe` |
| Fortran可执行文件 | `Relaxtime_fortran\debug_output.exe` |
| 对比报告 | `Julia_RelaxTime\docs\cross_language_comparison_report.md` |
| 三方对比报告 | `Julia_RelaxTime\docs\three_way_comparison_report.md` |

### 测试脚本
- `Julia_RelaxTime/scripts/debug/three_way_comparison.jl` - 三方对比测试
- `Relaxtime_fortran/codes/main/debug_output.f90` - Fortran调试输出程序
- `Relaxtime_fortran/scripts/build_debug.ps1` - Fortran编译脚本

## 结论

Julia与C++的计算结果在物理上是一致的，差异主要来自数值积分方法的不同：
- **夸克分布函数**: 完全一致
- **A积分**: 差异 <0.01%
- **B0积分**: 实部差异 ~1%，虚部完全一致
- **极化函数**: 实部差异 ~0.4%，虚部完全一致

这些差异在物理计算的可接受范围内，不需要立即修改代码。

---

## 高级模块对比结果 (2025-12-25更新)

### 5. K系数对比
| 参数 | Julia | C++ | 相对误差 |
|------|-------|-----|----------|
| K0_plus | 0.155428 | 0.155433 | 3.5e-5 |
| K0_minus | 0.238497 | 0.238504 | 2.8e-5 |
| K8_plus | 0.194872 | 0.194878 | 2.9e-5 |
| K8_minus | 0.199053 | 0.199059 | 3.2e-5 |
| det_K_plus | 0.030027 | 0.0300292 | 6.3e-5 |
| det_K_minus | 0.047212 | 0.047215 | 5.8e-5 |

**结论**: ✅ K系数完全一致，误差 < 0.01%

### 6. 传播子对比
| 通道 | Julia D | C++ D | 相对误差 |
|------|---------|-------|----------|
| t-channel P | -0.439161 | -0.439832 | 0.15% |
| t-channel S | 0.383996 | 0.384603 | 0.16% |
| s-channel P | -0.363+0.677i | -0.361+0.680i | 0.6% |
| s-channel S | 0.008+0.917i | 0.013+0.917i | 38% (实部) |

**注意**: s道S通道实部差异较大，但由于实部值很小(~0.01)，对总结果影响有限

### 7. 散射振幅平方 |M|² 对比
| t (fm⁻²) | Julia |M|² | C++ |M|² | 相对误差 |
|----------|---------|--------|----------|
| -13.0321 | 257.115 | 257.212 | 0.04% |
| -10.2475 | 258.134 | 258.673 | 0.21% |
| -6.6802 | 260.604 | 261.013 | 0.16% |
| -3.3331 | 264.016 | 264.555 | 0.20% |
| -0.5895 | 258.960 | 259.423 | 0.18% |

**结论**: ✅ |M|²误差约0.04%-0.21%，非常好

### 8. 微分截面 dσ/dt 对比
| t (fm⁻²) | Julia dσ/dt | C++ dσ/dt | 相对误差 |
|----------|-------------|-----------|----------|
| -13.0321 | 0.028572 | 0.028583 | 0.04% |
| -6.6802 | 0.028960 | 0.029005 | 0.16% |
| -0.5895 | 0.028777 | 0.028828 | 0.18% |

**结论**: ✅ 微分截面误差约0.04%-0.18%，非常好

### 9. 总截面 σ(s) 对比
| √s (MeV) | s (fm⁻²) | Julia σ | C++ σ | 相对误差 |
|----------|----------|---------|-------|----------|
| 222.4 | 1.27 | 4.183 | 4.607 | 9.2% |
| 359.8 | 3.32 | 0.444 | 0.447 | 0.6% |
| 505.1 | 6.55 | 0.531 | 0.528 | 0.5% |
| 731.1 | 13.73 | 0.272 | 0.283 | 3.8% |
| 900.0 | 20.80 | 0.167 | 0.168 | 0.3% |

**结论**: 
- 中高能区(s > 3)误差约0.3%-4%，可接受
- 低能区(s ≈ 1.27)误差约9%，可能与阈值附近的数值处理有关

---

## 总体评估

| 模块 | 误差范围 | 状态 |
|------|----------|------|
| 夸克分布函数 | ~2.5e-7 | ✅ 完全一致 |
| A积分 | < 0.01% | ✅ 完全一致 |
| K系数 | < 0.01% | ✅ 完全一致 |
| B0积分实部 | ~0.95% | ⚠️ 可接受 |
| B0积分虚部 | ~0 | ✅ 完全一致 |
| 极化函数 | 0.1%-0.4% | ✅ 良好 |
| 传播子 | 0.15%-0.6% | ✅ 良好 |
| |M|² | 0.04%-0.21% | ✅ 非常好 |
| dσ/dt | 0.04%-0.18% | ✅ 非常好 |
| σ(s) | 0.3%-9% | ⚠️ 可接受 |

**差异根本原因**: B0积分在k=0时的奇点处理方式不同
- C++: CPVI等距节点法
- Julia: QuadGK自适应积分

**建议**: 当前差异在物理可接受范围内，无需修改
