---
title: Log-Sum-Exp 数值稳定性评估报告
archived: true
original: docs/dev/log_sum_exp_evaluation.md
archived_date: 2026-01-19
---

以下为原始内容（保留，以便审阅与历史参考）：

***

# Log-Sum-Exp 数值稳定性评估报告

> 评估日期：2026-01-03
> 状态：✅ 已完成并集成

## 1. 背景

在 PNJL 模型中，计算 Polyakov loop 修正的对数项时：

```math
\ln(1 + 3\Phi \cdot e^{-x} + 3\bar{\Phi} \cdot e^{-2x} + e^{-3x})
```

其中 `x = (E - μ)/T`。当 x 很大（低温/高能量）或很小/负数（高温/低能量/大化学势）时，指数函数可能导致数值问题。

## 2. 实现

### 2.1 Log-Sum-Exp 技巧

在 `src/pnjl/core/Integrals.jl` 中实现：

```julia
@inline function log_polyakov_series_lse(a, Φ, Φ̄)
    # 找到最大指数：max(0, a, 2a, 3a)
    m = a > 0 ? 3.0 * a : zero(a)
    
    # 计算归一化后的项
    term = exp(-m) + 3.0 * Φ * exp(a - m) + 3.0 * Φ̄ * exp(2.0 * a - m) + exp(3.0 * a - m)
    
    return m + log(max(term, POLYAKOV_EPS))
end
```

### 2.2 修改的函数

- `calculate_log_term()`: 使用 LSE 技巧计算对数项
- `calculate_log_term_derivatives()`: 使用 LSE 技巧计算对数项及其导数

## 3. 评估结果

### 3.1 底层函数性能对比

| 测试用例 | 旧版本(ns) | 新版本(ns) | 比值 | 结果差异 |
|---------|-----------|-----------|------|---------|
| 正常区域 | 142 | 217 | 1.52x | < 1e-14 |
| 高温 | 163 | 287 | 1.76x | < 1e-14 |
| 中等μ | 196 | 330 | 1.68x | < 1e-14 |
| 低温高μ | 196 | 256 | 1.31x | < 1e-14 |
| 相变区域 | 183 | 179 | 0.98x | < 1e-14 |
| **平均** | - | - | **1.45x** | - |

批量计算（3072次调用）：
- 旧版本：0.108 ms
- 新版本：0.284 ms
- 比值：2.63x

### 3.2 T-μ 和 T-ρ 扫描性能对比（旧版本 vs 新版本）

**测试配置：**
- T-μ 扫描：T=50-200 MeV (步长25), μ=0-300 MeV (步长50), 共 49 点
- T-ρ 扫描：T=80,100,120,140,160 MeV, ρ=0-3 ρ₀ (步长0.2), 共 80 点
- 每项测试运行 3 次取平均

| 扫描类型 | 旧版本 (无 LSE) | 新版本 (有 LSE) | 性能比率 | 收敛率 |
|---------|----------------|----------------|---------|--------|
| T-μ 扫描 | 4.80 ms/点 | 4.78 ms/点 | **0.996x** | 100% |
| T-ρ 扫描 | 14.27 ms/点 | 15.50 ms/点 | **1.086x** | 100% |

**结论：LSE 实现性能与旧版本相当，差异 < 10%**

### 3.3 数值稳定性测试

| 测试场景 | 旧实现 | LSE 实现 | 结论 |
|---------|--------|---------|------|
| 正常物理区域 (T>50MeV, μ<500MeV) | ✅ 正常 | ✅ 正常 | 两者等效 |
| 极低温 (T<10MeV, x>60) | ⚠️ 下溢到0 | ⚠️ 下溢到0 | 物理上可接受 |
| 大化学势 (E<μ, x<-700) | ❌ 溢出Inf | ✅ 正常 | **LSE 解决** |
| x~-300 | ❌ 溢出Inf | ✅ 正常 | **LSE 解决** |

### 3.4 极端条件测试

| 条件 | 结果 |
|------|------|
| 极低温 (T=10 MeV) | ✅ 收敛 |
| 大化学势 (μ=600 MeV) | ✅ 收敛 |
| 低温+大μ (T=30, μ=500) | ✅ 收敛 |
| 极高温 (T=500 MeV) | ✅ 收敛 |
| 极端条件 (T=20, μ=700) | ✅ 收敛 |

## 4. 结论

### 4.1 性能影响

- **底层函数开销**：约 1.45-2.6x（取决于参数区域）
- **实际扫描性能影响**：
  - T-μ 扫描：**无影响** (0.996x)
  - T-ρ 扫描：**轻微开销** (~8.6%)
  - 平均开销：**< 5%**

### 4.2 数值稳定性改进

1. **LSE 技巧已成功集成**，解决了大化学势下的数值溢出问题
2. **所有极端条件测试均通过**
3. **收敛率保持 100%**，未引入新的收敛问题

### 4.3 权衡分析

| 方面 | 影响 |
|------|------|
| 底层函数性能 | ⚠️ 下降 1.5-2.6x |
| T-μ 扫描性能 | ✅ 无影响 |
| T-ρ 扫描性能 | ✅ 轻微开销 (~8%) |
| 数值稳定性 | ✅ 显著提高 |
| 代码复杂度 | ⚠️ 略有增加 |

**结论**：LSE 技巧以可接受的底层函数开销换取了显著的数值稳定性提升，对实际扫描性能影响可忽略（< 10%）。

## 5. 相关文件

- 实现：`src/pnjl/core/Integrals.jl`
- 评估脚本：`scripts/pnjl/evaluate_log_sum_exp.jl`
- 性能测试：`tests/perf/pnjl/scan_perf.jl`
- GitHub Action：`.github/workflows/pnjl-benchmarks.yml`
- TODO 文档：`docs/dev/PNJL_Phase_Diagram_TODO.md` (3.1节)