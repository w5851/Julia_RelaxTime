# Trho 连续链种子方案

本文记录利用 T-ρ 扫描生成连续种子链以支撑 T-μ 扫描和 Sobol/LHS 种子表的一套可复用流程。

## 目标

1. 避免 T-μ 求解多解区间中落入非物理分支；
2. 维持 (T, ξ) 方向的连续初值，减少求解失败；
3. 将高密度 Trho 结果缓存成可共享的 `.jld2` 链文件，方便重复使用。

## 总体流程

1. **连续扫描阶段**：
   - 先按 (T, ξ) 分桶，默认覆盖 `T=50:10:200 MeV`、`ξ` 列表（可配置）。
   - 采用 `ρ=3.0 → 0.0` 的递减顺序运行 Trho 扫描；为了提升 ρ→0 区域的分辨率，`ρ<0.3` 使用 0.01 步长，其余区域使用 0.05（实际实现允许自定义网格）。
   - 扫描过程中复用上一个 ρ 点的解作为初值，可直接沿用 `TrhoScan` 中的连续种子逻辑。

2. **曲线重采样 / 插值**：
   - 对每条 (T, ξ) 曲线记录 `(ρᵢ, μᵢ, stateᵢ)`，其中 `stateᵢ` 为长度 8 的 Trho 解向量（前三个拟序、两个 Polyakov、三个化学势）。
   - 基于 `μᵢ` 与目标 `μ_target` 的差值决定最邻近点；在需要时可扩展为线性插值，但初版实现采用最近邻保证稳定。

3. **缓存与消费**：
   - 每条曲线存成 `data/raw/pnjl/seeds/trho_continuation/chain_T{T}_xi{ξ}.jld2`，包含 `T`, `ξ`, `ρ` 样本、`μ` 列表以及对应解。
   - `generate_seed_table.jl` 或其他消费者在写入种子表之前，先根据 (T, ξ) 选择最近的链，再依据 `μ_target` 拿到对应的 state (取前 5 分量即可作为 `solve_fixed_mu` 初值)。

## 最近更新

- `PNJL.TrhoScan.DEFAULT_RHO_VALUES` 改为分段网格：`ρ>1.0` 保持 0.05 步长，`ρ<=1.0` 采用 0.02，`ρ<=0.3` 进一步细化到 0.01 甚至 0.005。这样 `TrhoScan` 与 `TrhoSeedChain.build_seed_chains` 输出的曲线在低密度端拥有 40+ 个采样点，可捕捉 μ(ρ) 的拐点细节。
- `scripts/pnjl/export_trho_seeds.jl` 直接读取链缓存并输出 `trho_seed_table.csv`，支持 `--xi`、`--rho-min/max` 与 `--stride`。种子表会附带三味化学势与 Polyakov 变量，方便其它扫描或 Sobol 表无缝复用。
- 链缓存目录保持在 `data/raw/pnjl/seeds/trho_continuation/`，执行 `PNJL.TrhoSeedChain.build_seed_chains` 后可一次性刷新 50–200 MeV (ΔT=10 MeV) 的 16 条链。若新增 T/ξ，只需再次运行构建函数，新的 `.jld2` 会覆盖旧文件。

## 设计要点

- **多 ξ、高温覆盖**：链构建脚本接受自定义 T/ξ 列表，并允许按需抽稀曲线，以控制文件大小。
- **高密度 ρ 网格**：默认网格在 `ρ<0.3` 时以 0.01 采样，可通过参数拓展。这样能够捕获 μ 的快速变化，避免 LHS 点落在未覆盖区域。
- **缓存格式**：`.jld2` 便于直接序列化 `Vector{Vector{Float64}}`，同时保存元数据（T、ξ、公差等）。
- **共享 API**：将链的生成、加载、最近邻查询封装为 `PNJL.TrhoSeedChain` 模块，供种子表脚本和其它扫描/求解器共用。

## 使用建议

1. 运行 `scripts/pnjl/build_trho_seed_chains.jl` 生成或刷新链文件，可用 `--T-min/--T-max/--T-step` 控制温度网格，用 `--xi-values`（逗号分隔）选择需要的 ξ，必要时再通过 `--rho-max` 与各种 step 选项微调密度分辨率；
2. 检查 `data/raw/pnjl/seeds/trho_continuation/` 是否覆盖了所需的温度与 ξ；
3. 生成 Sobol/LHS 种子表时启用 `--chain-dir`（默认已开启），以便自动注入连续初值；
4. 若新增温度/ξ 区间，先扩展链而后再导出种子表或运行 `TmuScan`。

该方案可以与现有的 `SeedCache` 并存：未生成链的 (T, ξ) 仍会退回到传统最近邻种子表，而已经生成的区域将享受连续分支带来的收敛性改进。