# PNJL 相图中的 Maxwell 等面积法：ρ–μ 与 P–μ 两种路线

整理 PNJL 模型在求解一阶相变线时常用的两类 Maxwell 等面积实现，供后续实现步骤 6（相变线判定）时参考。

## 1. ρ–μ 曲线等面积法

| 方面 | 说明 |
|------|------|
| 数据来源 | 直接使用 `TrhoScan` 生成的 CSV（T、ρ、μ 三元组）；每个温度固定后得到一条 ρ(μ) 曲线，天然带有 S 形信息。
| 数学形式 | 要求在同一温度下，沿 ρ 方向积分化学势：`∫_{ρ_g}^{ρ_l} [μ(ρ) - μ_coex] dρ = 0`；几何意义是 ρ–μ 曲线上两块面积相等。
| 实现便利性 | 已经通过 `PhaseTransition.detect_s_shape` 得到自旋odal 点，可以用作积分上下限以及初始 μ_coex 初猜；扫描仅依赖 T-ρ 数据，不需要额外 T-μ 虚拟分支。 |
| 数值注意事项 | ρ 网格需足够密；若 ρ 采样过稀，需要分段插值（样条/分段线性）后再积分；需要处理 ρ 负向或超高密度处的噪声。 |
| 优点 | ① 与 S 形检测共享同一数据与预处理；② 可以直接输出 ρ_g、ρ_l；③ 对各向异性情况下（固定 ρ 扫描）更稳定。 |
| 缺点 | 面积公式较少在文献中出现，解释时需明确“化学势-密度”形式；对 μ(ρ) 的多值段需额外排序和去重。 |

## 2. P–μ 曲线等面积法

| 方面 | 说明 |
|------|------|
| 数据来源 | 需要 `TmuScan` 生成的多值 P(μ) 曲线；要获取回环，需要在同一温度下分别从低 μ、由低→高与高→低两个方向求解，或根据 seeds/ρ 控制以抓取不同分支。 |
| 数学形式 | 经典 Maxwell 条件：`∫_{μ_1}^{μ_2} [P(μ) - P_coex] dμ = 0`，同时 `P(μ_1) = P(μ_2) = P_coex`；求解后 μ_1、μ_2 即两相化学势，`μ_coex` 取中值或返回两端。 |
| 实现便利性 | 需要构建“上/下”两条 μ→P 分支，或通过参数化（如按 ρ 标签）区分；若只有单向扫描，会缺少回环信息。 |
| 数值注意事项 | 压力对 μ 较平滑，但若数据点稀疏，求等面积需要插值；必须保证两个分支覆盖同样的 μ 区间，否则无法闭合。 |
| 优点 | ① 与热力学教科书一致，解释更直接；② 等面积条件只涉及压力，易与 EOS 模型比较；③ 便于与 `solve_fixed_mu` 结果一体化。 |
| 缺点 | ① 需额外控制求解方向以捕获多值分支；② 若未能生成回环，算法无法进行；③ 对数值噪声较敏感，积分前最好光滑化。 |

## 3. 选择建议

1. **若以 `TrhoScan` 为核心**（当前管线已经完成 T-ρ 扫描 + S 形检测）：推荐先实现 ρ–μ 等面积。理由：
   - 与 `PhaseTransition.detect_s_shape` 共用输入，可直接利用自旋odal 作为积分端点；
   - 求得的 `μ_coex` 同时伴随 `(ρ_g, ρ_l)`，方便绘制 ρ–μ 图与标记相界。

2. **若后续需要与外部 EOS 对比或引入 P–μ 观测**（例如对标 PNJL_Simulation 或与实验/格点数据对齐）：在 ρ–μ 算法稳定后，可以再实现 P–μ 等面积，以便输出 `μ_1`, `μ_2`, `P_coex` 等经典量。

3. 实际实现顺序可为：
   - 使用 ρ–μ 方案得到初步一阶相变线与 CEP；
   - 以该结果为初猜，对 P–μ 曲线做增量验证或细化（例如：对固定温度，找到 `μ_1`, `μ_2` 使得 `P(μ_1)=P(μ_2)`，再用等面积约束微调）。

> 结论：**两种方案都可行，但当前项目的数据流（TrhoScan → S 形检测）更适合先执行 ρ–μ 路线。** 待 ρ–μ 等面积实现稳定后，再扩展 P–μ 等面积以提升与传统文献的一致性。

## 4. 数据产物与诊断

- `data/processed/results/pnjl/maxwell_results.csv`：逐温度的求解状态、`μ_coex`、`ρ_g/ρ_l` 以及失败原因。
- `data/processed/results/pnjl/maxwell_inputs.csv`：对每个温度写出**排序后的** `(ρ, μ)` 样本，并附带 `has_s_shape`、`μ_spinodal_low/high`。调试 Maxwell 失败（如 `no_sign_change`）时，无需重新加载原始 `TrhoScan` CSV，直接用该文件即可重建曲线或绘图。

推荐流程：
1. 若 `maxwell_results.csv` 出现 `no_s_shape` 或 `no_sign_change`，先在 `maxwell_inputs.csv` 中过滤对应 T/ξ 行；
2. 用 Python/Julia 读取 `ρ`–`μ` 数组绘图，确认 S 形是否真实缺失或仅因采样过稀；
3. 视情况调整 Trho 扫描网格（例如减小 ρ 步长）或微调 `detect_s_shape` 阈值，再重新运行 `plot_phase_diagram.jl`。