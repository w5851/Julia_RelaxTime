# 步骤 1 结果总结: σ(s) 对比

**日期**: 2026-01-27
**状态**: ✅ 完成

---

## 🎯 目标

对比 Fortran 和 Julia 在相同 s 值下计算的 σ(s),排除散射截面计算的差异。

---

## 📊 结果

### σ(s) 对比表

| i | s (fm⁻²) | σ_Julia (fm²) | σ_Fortran (fm²) | 差异 |
|---|----------|---------------|-----------------|------|
| 1 | 4.2668 | 5.784×10⁻¹ | 5.708×10⁻¹ | **1.33%** |
| 13 | 7.3853 | 4.769×10⁻² | 4.768×10⁻² | 0.01% |
| 25 | 10.5039 | 5.293×10⁻² | 5.293×10⁻² | 0.01% |
| 37 | 13.6224 | 5.862×10⁻² | 5.858×10⁻² | 0.06% |
| 49 | 16.7410 | 6.378×10⁻² | 6.374×10⁻² | 0.05% |
| 61 | 19.8595 | 6.848×10⁻² | 6.847×10⁻² | 0.03% |
| 73 | 22.9781 | 7.293×10⁻² | 7.290×10⁻² | 0.03% |
| 85 | 26.0966 | 7.729×10⁻² | 7.725×10⁻² | 0.04% |
| 97 | 29.2152 | 8.175×10⁻² | 8.159×10⁻² | 0.20% |
| 109 | 32.3337 | 8.654×10⁻² | 8.638×10⁻² | 0.18% |
| 121 | 35.4523 | 9.196×10⁻² | 9.191×10⁻² | 0.05% |

**最大差异**: 1.33% (在阈值附近)

---

## ✅ 结论

### 1. σ(s) 计算基本一致

**所有点的差异都 < 2%**,大部分点 < 0.2%

这说明:
- ✅ 散射振幅 M² 的计算一致
- ✅ 微分截面 dσ/dt 的计算一致
- ✅ t 积分的实现一致

### 2. 阈值附近的小差异

**第一个点 (s = 4.2668 fm⁻², s/s_th = 1.001) 的差异最大 (1.33%)**

可能原因:
- 阈值附近 σ(s) 变化剧烈
- 数值积分的细微差异被放大
- Fortran 的 s_bo 设置可能略有不同

但这个差异**不足以解释 36% 的散射率差异**!

### 3. 排除散射截面计算的问题

**结论**: 散射截面 σ(s) 的计算**不是**差异的根源!

---

## 🔍 关键发现

### 阈值附近的 σ(s) 异常大

第一个点: s = 4.2668 fm⁻² (s/s_th = 1.001)
- σ_Fortran = 0.571 fm²
- σ_Julia = 0.578 fm²

这个值比其他点大约 **10 倍**!

**物理解释**:
```
σ(s) ∝ √(s - s_th) / s
```

在阈值附近 (s → s_th):
- 分子 √(s - s_th) → 0
- 但分母 s 也很小
- 导致 σ(s) 可能很大

**数值问题**:
- Fortran 的 s_bo = s_th × (1 + 10⁻³) = 4.2668 fm⁻²
- 第一个点恰好在 s_bo 附近
- 可能存在数值不稳定性

### 其他点的 σ(s) 非常一致

**除了第一个点,所有其他点的差异都 < 0.2%**

这说明:
- 在远离阈值的区域,两种实现完全一致
- 数值积分方法没有系统性差异
- 物理公式的实现一致

---

## 📈 σ(s) 的行为

### 随 s 的变化

| s/s_th | σ (fm²) | 趋势 |
|--------|---------|------|
| 1.001 | 0.571 | 阈值奇点 |
| 1.73 | 0.048 | 快速下降 |
| 2.46 | 0.053 | 缓慢上升 |
| 3.19 | 0.059 | 继续上升 |
| 3.93 | 0.064 | 继续上升 |
| ... | ... | ... |
| 8.31 | 0.092 | 接近上限 |

**物理图像**:
1. **阈值附近** (s/s_th ~ 1): σ 很大,但相空间很小
2. **中间区域** (s/s_th ~ 2-5): σ 缓慢增加
3. **高能区域** (s/s_th > 5): σ 继续增加

---

## 🎯 下一步

### 既然 σ(s) 一致,差异来自哪里?

**可能的原因**:

1. **插值方法** ⭐⭐⭐
   - Julia 使用 PCHIP 插值
   - Fortran 使用线性插值
   - 在阈值附近可能有差异

2. **积分权重** ⭐⭐⭐⭐⭐
   - 不同的 (p_i, p_j, Θ) 组合给出相同的 s
   - 但它们的积分权重不同
   - 这可能导致平均散射率不同

3. **角度积分方式** ⭐⭐⭐⭐⭐
   - Fortran: 1D 角度积分 (angel)
   - Julia: 3D 角度积分 (cosθ_i, cosθ_j, φ)
   - 对于相同的 s,两种方法采样的相空间点不同

### 建议的调查顺序

1. **测试插值方法的影响** (步骤 2A)
   - 增加 σ(s) 缓存点数
   - 观察结果是否收敛

2. **测试积分节点数的影响** (步骤 2B, 2C, 2D)
   - 增加动量、角度、方位角节点数
   - 观察哪个影响最大

3. **实现 Fortran 的角度积分方式** (步骤 3)
   - 在 Julia 中实现 1D 角度积分
   - 直接对比两种方法

---

## 📝 技术细节

### Fortran 的 σ(s) 计算

```fortran
! 预先计算 σ(s) 在 [s_bo, s_up] 范围内
h = (s_up-s_bo) / (nn-1)
s_cmk(:) = arth(s_bo, h, nn)  ! 等间距网格
do k = 1, nn
    sig(k) = tint(s_cmk(k), qk_code(:,:))  ! 调用 t 积分
end do

! 在积分中使用线性插值
i0 = floor((s_cm-s_bo)/h) + 1
inc = (sig(i0+1)-sig(i0)) / (s_cmk(i0+1)-s_cmk(i0))
sig_ij = inc*(s_cm-s_cmk(i0)) + sig(i0)
```

### Julia 的 σ(s) 计算

```julia
# 使用 w0cdf 设计的非均匀网格
s_grid = design_w0cdf_s_grid(...)  # 根据积分权重分布

# 预计算 σ(s)
for s in s_grid
    σ = total_cross_section(process, s, ...)
end

# 使用 PCHIP 插值
σ_interp = pchip_interpolate(s_grid, σ_vals, s)
```

**关键差异**:
- Fortran: 均匀网格 + 线性插值
- Julia: 非均匀网格 (w0cdf) + PCHIP 插值

---

*分析完成时间: 2026-01-27*
*状态: σ(s) 一致,差异来自其他地方*
*下一步: 测试插值和积分节点数的影响*
