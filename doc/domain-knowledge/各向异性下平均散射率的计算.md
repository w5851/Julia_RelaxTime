好 — 我把 **各向异性（lab/介质系下分布）** 情形下，用微分散射截面 ( \dfrac{d\sigma}{dt} ) 写出的**平均散射率**公式写清楚、并把每个符号解释清楚（以便你直接在代码里实现）。公式保持严格性：把 (d\sigma/dt) 放在积分内部（你上面决定不用把 (s,t) 提到外面），且出射占据因子用实验室系下的出射能量（由入射动量和 (t) 决定）。

---

## 主要结果（紧凑形式）

令态密度
[
\rho_i=\int\frac{d^3p}{(2\pi)^3},f_i(\mathbf p)
]
则粒子种类 (i+j\to c+d) 的**平均散射率**（per-pair, thermal averaged rate）写为

[
\boxed{%
\bar w_{ij}
=\frac{1}{\rho_i,\rho_j}
\int!\frac{d^3p_i}{(2\pi)^3},\frac{d^3p_j}{(2\pi)^3};
f_i^{\rm lab}(\mathbf p_i),f_j^{\rm lab}(\mathbf p_j);v_{\rm rel}(\mathbf p_i,\mathbf p_j)
\int_{t_-(\mathbf p_i,\mathbf p_j)}^{t_+(\mathbf p_i,\mathbf p_j)} dt;
\frac{d\sigma}{dt}\big(s(\mathbf p_i,\mathbf p_j),t\big);
\big(1\pm f_c^{\rm lab}(\mathbf p_c)\big)\big(1\pm f_d^{\rm lab}(\mathbf p_d)\big)
}
]

这就是你需要的、在各向异性下使用 (d\sigma/dt) 的完全表达式：

* 所有的分布函数 (f^{\rm lab}) 都在**实验室/介质系**定义（各向异性体现在这里）。
* (d\sigma/dt) 只以 (s,t) 为输入（可用查表或 NN 预测）。
* (v_{\rm rel})、(s)、积分上下限 (t_\pm)、以及出射动量 (\mathbf p_{c,d}) 都显式地由入射 (\mathbf p_i,\mathbf p_j) 和 (t) 决定。

---

## 变量定义与计算细节

1. **不变量 (s)**（由入射动量给出）：
   [
   s(\mathbf p_i,\mathbf p_j) ;=; (E_i+E_j)^2 - |\mathbf p_i+\mathbf p_j|^2,
   \qquad E_{i}=\sqrt{|\mathbf p_i|^2+m_i^2}.
   ]

2. **相对速度 (v_{\rm rel})**（不变量形式，lab 中使用）：
   [
   v_{\rm rel}(\mathbf p_i,\mathbf p_j) ;=;
   \frac{\sqrt{(p_i\cdot p_j)^2 - m_i^2 m_j^2}}{E_i E_j},
   \quad\text{其中 } p^\mu=(E,\mathbf p).
   ]

3. **微分散射截面**
   (\dfrac{d\sigma}{dt}(s,t)) —— 由微扰理论或数值计算得到，仅依赖 (s) 和 (t)。

4. **t 的上下限**（给出一般表达；与你之前写的等价）：
   [
   t_{\pm}(\mathbf p_i,\mathbf p_j)
   = m_i^2 + m_c^2 - \frac{1}{2s},(s+m_i^2-m_j^2)(s+m_c^2-m_d^2)
   \pm \frac{1}{2s},2\sqrt{\lambda(s,m_i^2,m_j^2),\lambda(s,m_c^2,m_d^2)} ,
   ]
   其中常用 Källén 函数 (\lambda(x,y,z)=x^2+y^2+z^2-2xy-2xz-2yz)。
   （此式与你提供的 (t_\pm) 等价，且显式依赖 (s) —— 而 (s) 又由 (\mathbf p_i,\mathbf p_j) 给出。）

5. **出射四动量 / 能量 (\mathbf p_c,\mathbf p_d)**：

* 在质心系（CM）中，固定 (s) 与 (t) 就确定了 CM 下出射能量 (E_c^*), (E_d^*) 与出射角 (\cos\theta^*)（通过 (t\leftrightarrow\cos\theta^*)）。
* 把 CM 下的出射四动量 **boost 回实验室系**（由总四动量 (P^\mu=p_i+p_j) 的速度决定）得到实验室系下 (\mathbf p_c(\mathbf p_i,\mathbf p_j,t)) 和 (\mathbf p_d(\mathbf p_i,\mathbf p_j,t))。
* 然后把这些实验室动量放入分布函数：(f_c^{\rm lab}(\mathbf p_c)), (f_d^{\rm lab}(\mathbf p_d))。

（实现时建议：在数值上用 CM→lab 的标准 Lorentz boost： (p_c^{\mu}(\text{lab})= \Lambda^\mu{}_\nu(P) , p_c^{\nu}(\text{CM}))。）

6. **占据因子** ((1\pm f))：

* 这里 (\pm) 对应费米子/玻色子，且 (f) 是实验室系下的占据数（含各向异性）。
* 注意：若你是计算经典极限（稀薄极限），可近似 ((1\pm f)\approx 1)。

---

## 数值实现建议（与公式对应，便于你把 (d\sigma/dt) 放在内部并用插值）

* 在外层对 (\mathbf p_i,\mathbf p_j) 做积分（可用 Gauss-Legendre 对极角/方位角做网格，对模长做适当变换如 log 或高斯-勒让德带权），在每个点：

  1. 计算 (s) 与 (v_{\rm rel})。
  2. 建立 (t) 的上下限 (t_\pm(s))（注意依赖 (\mathbf p_i,\mathbf p_j) 的几何），在该区间用适当节点对 (t) 做内层积分。
  3. 在每个 (t) 节点：

     * 从 (s,t) 得到 CM 出射 4-矢量，再做 boost 得到 (\mathbf p_c,\mathbf p_d)。
     * 计算阻塞因子 ((1\pm f_c)(1\pm f_d))。
     * 得到 (d\sigma/dt(s,t))（通过插值表或 NN），累加到内层积分。
  4. 将内层 (t) 积分结果乘上 (f_i(\mathbf p_i) f_j(\mathbf p_j) v_{\rm rel}) 和外层量度后累加。
* 最后除以 (\rho_i\rho_j)。

**性能提示**：

* 把 (d\sigma/dt(s,t)) 预先在合适的 ((s,t)) 网格上做高精度、做对数/变换平滑后存表，内层直接查表插值。
* 在 ((s,t)) 上做变换（例如对 (s) 用 (\log(s-s_0))、对 (t) 用 (\cos\theta^*) 或 (\log(-t))）可让插值更稳定。
* 若 (d\sigma/dt) 在某些区域变化极剧烈（小角 / 阈值 / 共振），对这些区域专门加密网格或用解析主项分离（singular + smooth residual）会有帮助。

---

## 总结要点（一句话）

上面给出的公式把**各向异性分布（lab 系）**和**仅依赖 (s,t) 的微分截面**严格耦合起来：在数值上你仍然把 (d\sigma/dt(s,t)) 当作一个内部被调用的函数（可用插值/NN），但**积分结构没有把它随意提出最外层**，从而保证了分布函数始终以实验室系动量为参数，结果是物理正确且可实现的。

---


